<!DOCTYPE html>
<html manifest="cache.appcache">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="theme-color" content="#000000" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>loading...</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style>
    #err:empty {
      display: none;
    }
  </style>
</head>

<body class="xs:hidden bg-black">
  $(if chap-id)
  <form name="sendin" action="$(link-login-only)" method="post">
    <input type="hidden" name="username" />
    <input type="hidden" name="password" />
    <input type="hidden" name="dst" value="$(link-orig)" />
    <input type="hidden" name="popup" value="true" />
  </form>

  <noscript>
    Your browser does not support JavaScript! This may bring issues with our new checkout system. <a
      href="auth.ezwifi.co.ke">Please click Here to Open in Chrome or Mozilla.</a>
  </noscript>
  <script>
    /*
    * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
    * Digest Algorithm, as defined in RFC 1321.
    * Version 1.1 Copyright (C) Paul Johnston 1999 - 2002.
    * Code also contributed by Greg Holt
    * See http://pajhome.org.uk/site/legal.html for details.
    */

    /*
     * Add integers, wrapping at 2^32. This uses 16-bit operations internally
     * to work around bugs in some JS interpreters.
     */
    function safe_add(x, y) {
      var lsw = (x & 0xFFFF) + (y & 0xFFFF)
      var msw = (x >> 16) + (y >> 16) + (lsw >> 16)
      return (msw << 16) | (lsw & 0xFFFF)
    }

    /*
     * Bitwise rotate a 32-bit number to the left.
     */
    function rol(num, cnt) {
      return (num << cnt) | (num >>> (32 - cnt))
    }

    /*
     * These functions implement the four basic operations the algorithm uses.
     */
    function cmn(q, a, b, x, s, t) {
      return safe_add(rol(safe_add(safe_add(a, q), safe_add(x, t)), s), b)
    }
    function ff(a, b, c, d, x, s, t) {
      return cmn((b & c) | ((~b) & d), a, b, x, s, t)
    }
    function gg(a, b, c, d, x, s, t) {
      return cmn((b & d) | (c & (~d)), a, b, x, s, t)
    }
    function hh(a, b, c, d, x, s, t) {
      return cmn(b ^ c ^ d, a, b, x, s, t)
    }
    function ii(a, b, c, d, x, s, t) {
      return cmn(c ^ (b | (~d)), a, b, x, s, t)
    }

    /*
     * Calculate the MD5 of an array of little-endian words, producing an array
     * of little-endian words.
     */
    function coreMD5(x) {
      var a = 1732584193
      var b = -271733879
      var c = -1732584194
      var d = 271733878

      for (i = 0; i < x.length; i += 16) {
        var olda = a
        var oldb = b
        var oldc = c
        var oldd = d

        a = ff(a, b, c, d, x[i + 0], 7, -680876936)
        d = ff(d, a, b, c, x[i + 1], 12, -389564586)
        c = ff(c, d, a, b, x[i + 2], 17, 606105819)
        b = ff(b, c, d, a, x[i + 3], 22, -1044525330)
        a = ff(a, b, c, d, x[i + 4], 7, -176418897)
        d = ff(d, a, b, c, x[i + 5], 12, 1200080426)
        c = ff(c, d, a, b, x[i + 6], 17, -1473231341)
        b = ff(b, c, d, a, x[i + 7], 22, -45705983)
        a = ff(a, b, c, d, x[i + 8], 7, 1770035416)
        d = ff(d, a, b, c, x[i + 9], 12, -1958414417)
        c = ff(c, d, a, b, x[i + 10], 17, -42063)
        b = ff(b, c, d, a, x[i + 11], 22, -1990404162)
        a = ff(a, b, c, d, x[i + 12], 7, 1804603682)
        d = ff(d, a, b, c, x[i + 13], 12, -40341101)
        c = ff(c, d, a, b, x[i + 14], 17, -1502002290)
        b = ff(b, c, d, a, x[i + 15], 22, 1236535329)

        a = gg(a, b, c, d, x[i + 1], 5, -165796510)
        d = gg(d, a, b, c, x[i + 6], 9, -1069501632)
        c = gg(c, d, a, b, x[i + 11], 14, 643717713)
        b = gg(b, c, d, a, x[i + 0], 20, -373897302)
        a = gg(a, b, c, d, x[i + 5], 5, -701558691)
        d = gg(d, a, b, c, x[i + 10], 9, 38016083)
        c = gg(c, d, a, b, x[i + 15], 14, -660478335)
        b = gg(b, c, d, a, x[i + 4], 20, -405537848)
        a = gg(a, b, c, d, x[i + 9], 5, 568446438)
        d = gg(d, a, b, c, x[i + 14], 9, -1019803690)
        c = gg(c, d, a, b, x[i + 3], 14, -187363961)
        b = gg(b, c, d, a, x[i + 8], 20, 1163531501)
        a = gg(a, b, c, d, x[i + 13], 5, -1444681467)
        d = gg(d, a, b, c, x[i + 2], 9, -51403784)
        c = gg(c, d, a, b, x[i + 7], 14, 1735328473)
        b = gg(b, c, d, a, x[i + 12], 20, -1926607734)

        a = hh(a, b, c, d, x[i + 5], 4, -378558)
        d = hh(d, a, b, c, x[i + 8], 11, -2022574463)
        c = hh(c, d, a, b, x[i + 11], 16, 1839030562)
        b = hh(b, c, d, a, x[i + 14], 23, -35309556)
        a = hh(a, b, c, d, x[i + 1], 4, -1530992060)
        d = hh(d, a, b, c, x[i + 4], 11, 1272893353)
        c = hh(c, d, a, b, x[i + 7], 16, -155497632)
        b = hh(b, c, d, a, x[i + 10], 23, -1094730640)
        a = hh(a, b, c, d, x[i + 13], 4, 681279174)
        d = hh(d, a, b, c, x[i + 0], 11, -358537222)
        c = hh(c, d, a, b, x[i + 3], 16, -722521979)
        b = hh(b, c, d, a, x[i + 6], 23, 76029189)
        a = hh(a, b, c, d, x[i + 9], 4, -640364487)
        d = hh(d, a, b, c, x[i + 12], 11, -421815835)
        c = hh(c, d, a, b, x[i + 15], 16, 530742520)
        b = hh(b, c, d, a, x[i + 2], 23, -995338651)

        a = ii(a, b, c, d, x[i + 0], 6, -198630844)
        d = ii(d, a, b, c, x[i + 7], 10, 1126891415)
        c = ii(c, d, a, b, x[i + 14], 15, -1416354905)
        b = ii(b, c, d, a, x[i + 5], 21, -57434055)
        a = ii(a, b, c, d, x[i + 12], 6, 1700485571)
        d = ii(d, a, b, c, x[i + 3], 10, -1894986606)
        c = ii(c, d, a, b, x[i + 10], 15, -1051523)
        b = ii(b, c, d, a, x[i + 1], 21, -2054922799)
        a = ii(a, b, c, d, x[i + 8], 6, 1873313359)
        d = ii(d, a, b, c, x[i + 15], 10, -30611744)
        c = ii(c, d, a, b, x[i + 6], 15, -1560198380)
        b = ii(b, c, d, a, x[i + 13], 21, 1309151649)
        a = ii(a, b, c, d, x[i + 4], 6, -145523070)
        d = ii(d, a, b, c, x[i + 11], 10, -1120210379)
        c = ii(c, d, a, b, x[i + 2], 15, 718787259)
        b = ii(b, c, d, a, x[i + 9], 21, -343485551)

        a = safe_add(a, olda)
        b = safe_add(b, oldb)
        c = safe_add(c, oldc)
        d = safe_add(d, oldd)
      }
      return [a, b, c, d]
    }

    /*
     * Convert an array of little-endian words to a hex string.
     */
    function binl2hex(binarray) {
      var hex_tab = "0123456789abcdef"
      var str = ""
      for (var i = 0; i < binarray.length * 4; i++) {
        str += hex_tab.charAt((binarray[i >> 2] >> ((i % 4) * 8 + 4)) & 0xF) +
          hex_tab.charAt((binarray[i >> 2] >> ((i % 4) * 8)) & 0xF)
      }
      return str
    }

    /*
     * Convert an array of little-endian words to a base64 encoded string.
     */
    function binl2b64(binarray) {
      var tab = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
      var str = ""
      for (var i = 0; i < binarray.length * 32; i += 6) {
        str += tab.charAt(((binarray[i >> 5] << (i % 32)) & 0x3F) |
          ((binarray[i >> 5 + 1] >> (32 - i % 32)) & 0x3F))
      }
      return str
    }

    /*
     * Convert an 8-bit character string to a sequence of 16-word blocks, stored
     * as an array, and append appropriate padding for MD4/5 calculation.
     * If any of the characters are >255, the high byte is silently ignored.
     */
    function str2binl(str) {
      var nblk = ((str.length + 8) >> 6) + 1 // number of 16-word blocks
      var blks = new Array(nblk * 16)
      for (var i = 0; i < nblk * 16; i++) blks[i] = 0
      for (var i = 0; i < str.length; i++)
        blks[i >> 2] |= (str.charCodeAt(i) & 0xFF) << ((i % 4) * 8)
      blks[i >> 2] |= 0x80 << ((i % 4) * 8)
      blks[nblk * 16 - 2] = str.length * 8
      return blks
    }

    /*
     * Convert a wide-character string to a sequence of 16-word blocks, stored as
     * an array, and append appropriate padding for MD4/5 calculation.
     */
    function strw2binl(str) {
      var nblk = ((str.length + 4) >> 5) + 1 // number of 16-word blocks
      var blks = new Array(nblk * 16)
      for (var i = 0; i < nblk * 16; i++) blks[i] = 0
      for (var i = 0; i < str.length; i++)
        blks[i >> 1] |= str.charCodeAt(i) << ((i % 2) * 16)
      blks[i >> 1] |= 0x80 << ((i % 2) * 16)
      blks[nblk * 16 - 2] = str.length * 16
      return blks
    }

    /*
     * External interface
     */
    function hexMD5(str) { return binl2hex(coreMD5(str2binl(str))) }
    function hexMD5w(str) { return binl2hex(coreMD5(strw2binl(str))) }
    function b64MD5(str) { return binl2b64(coreMD5(str2binl(str))) }
    function b64MD5w(str) { return binl2b64(coreMD5(strw2binl(str))) }
    /* Backward compatibility */
    function calcMD5(str) { return binl2hex(coreMD5(str2binl(str))) }

  </script>
  <script type="text/javascript">
    function doLogin() {
      document.sendin.username.value = document.login.username.value;
      document.sendin.password.value = hexMD5('$(chap-id)' + 'user' + '$(chap-challenge)');
      document.sendin.submit();
      return false;
    }
  </script>
  $(endif)
  <div class="h-screen">
    <!-- <img id="logo" class="w-1/3 md:1/3 py-10 mx-auto" alt="logo"> -->
    <div class="hidden md:w-1/2 bg-green-200 my-5 px-4 py-4 mx-auto rounded-md" id="notification">
    </div>
    <div class="mx-auto">
      <p class="bg-red-200 my-5 px-4 py-4 rounded-md text-red-900 font-bold" id="err">$(if error) $(error) $(endif)</p>
    </div>
    <div class="py-10">

      <form name="login" action="$(link-login-only)" method="post" $(if chap-id) onSubmit="return doLogin()" $(endif)>
        <div class="md:w-1/2 mx-auto flex flex-col">
          <p class="text-center text-white font-4xl m-5" id="wifi_name"></p>
          <input autofocus type="text" name="username"
            class="h-14 px-5 rounded-md appearance-none focus:outline-none focus:shadow-outline w-3/4 mx-auto"
            placeholder="Access Code" />
          <p class="text-white text-center"><small>Once you pay, enter M-PESA Transaction Number here</small></p>
          <button
            class="bg-yellow-400 h-14 appearance-none focus:outline-none focus:shadow-outline rounded-md w-3/4 my-4 font-bold mx-auto"
            type="submit">
            Login
          </button>
        </div>
      </form>
    </div>

    <div class="w-full mx-auto">
      <div>
        <div id="price_quota" class="flex justify-center"></div>
        <div id="time_limit" class="flex justify-center"></div>
        <div id="product_category_2" class="flex justify-center"></div>
      </div>
      <div class="md:w-2/3 mx-auto flex flex-col border-2 border-white mt-5 rounded">
        <p class="text-white text-center mt-4"><small>Tap Data above and enter phone number to pay</small></p>
        <input autofocus type="text" id="phone" name="phone"
          class="h-14 px-5 rounded-md appearance-none focus:outline-none focus:shadow-outline w-3/4 mx-auto"
          placeholder="Enter Phone" />
        <input hidden type="text" id="amount">
        <button
          class="bg-yellow-400 h-14 appearance-none focus:outline-none focus:shadow-outline rounded-md w-3/4 my-4 font-bold mx-auto"
          id="buy-form">
          Pay Now
        </button>
      </div>
    </div>
    <div
      class="md:w-2/4 md:px-5 md:mx-auto bg-green-700 my-5 text-white ring-white ring-offset-2 flex  md:flex-col justify-center items-center mx-auto px-2 py-4">
      <div>
        <h1 class="text-xl font-bold">How To Buy</h1>
        <h1 id="paytype" class="text-sm"></h1>
      </div>
      <div>
        <h1 id="paybill" class="text-5xl font-bold"></h1>
      </div>
    </div>
  </div>
  </p>
  <script src="jquery.min.js"></script>
  <script src="swal.js"></script>

  <script>
    $(function () {
      var server, lnmolink, shortcode, title, pybillType, Paybill;
      $.getJSON("prices.json", function (data) {

        if (data) {
          const quota = data.quota, limit = data.duration, 
          // added this 
          product_category_2 = data.product_category_2

          server = data.server
          lnmolink = data.lnmoapi
          shortcode = data.shortcode
          pybillType = data.paybill == 0 ? 'M-PESA Buy Goods' : 'M-PESA PayBill'
          Paybill = data.paybill_no

          // $("#logo").attr("src", data.logo)
          $("title, #wifi_name").text(data.title)
          $("#paytype").text(pybillType)
          $("#paybill").text(Paybill)

          quota.map((data_q) => {
            $("#price_quota").append(`
                <div onclick="dvalue(${data_q.price})" class="bg-${data_q.color}-600 ring ring-${data_q.color}-600 ring-offset-2 border-2 px-1 py-1 h-28 w-28 shadow rounded-full text-white flex flex-col justify-center items-center hover:bg-gray-700">
                  <h1 class="text-4xl font-bold">${data_q.price}/-</h1>
                  <p class="font-bold px-0 leading-3">
                    <small>${data_q.quota_limit}</small>
                  </p>
                  <p class="text-xs py-0 leading-3"><small>Max 2Mbps</small></p>
                </div>
              `)
          })
          // Options More Data
          // copy paste and change this data_q to product_category_2 if data, or if unlimited, use the time_limit
          // quota.map((product_category_2) => {
          //   $("#price_quota").append(`
          //       <div onclick="dvalue(${data_q.price})" class="bg-${data_q.color}-600 ring ring-${data_q.color}-600 ring-offset-2 border-2 px-1 py-1 h-28 w-28 shadow rounded-full text-white flex flex-col justify-center items-center hover:bg-gray-700">
          //         <h1 class="text-4xl font-bold">${data_q.price}/-</h1>
          //         <p class="font-bold px-0 leading-3">
          //           <small>${data_q.quota_limit}</small>
          //         </p>
          //         <p class="text-xs py-0 leading-3"><small>Max 2Mbps</small></p>
          //       </div>
          //     `)
          // })

          limit.map((limit_data) => {
            $("#time_limit").append(`
                  <div onclick="dvalue(${limit_data.price})" class="bg-${limit_data.color}-600 ring ring-${limit_data.color}-600 ring-offset-2 border-2 px-1 py-1 h-28 w-28 shadow rounded-full text-white flex flex-col justify-center items-center hover:bg-gray-700">
                    <h1 class="text-4xl font-bold">${limit_data.price}/-</h1>
                    <p class="font-bold px-0 leading-3">
                      <small>${limit_data.quota_limit}</small>
                    </p>
                    <p class="text-xs py-0 leading-3"><small>Max 2Mbps</small></p>
                  </div>
              `)
          })
          // Option More Unlimited
          limit.map((product_category_2) => {
            $("#product_category_2").append(`
                  <div onclick="dvalue(${limit_data.price})" class="bg-${limit_data.color}-600 ring ring-${limit_data.color}-600 ring-offset-2 border-2 px-1 py-1 h-28 w-28 shadow rounded-full text-white flex flex-col justify-center items-center hover:bg-gray-700">
                    <h1 class="text-4xl font-bold">${limit_data.price}/-</h1>
                    <p class="font-bold px-0 leading-3">
                      <small>${limit_data.quota_limit}</small>
                    </p>
                    <p class="text-xs py-0 leading-3"><small>Max 2Mbps</small></p>
                  </div>
              `)
          })
        }

        // thats all, the UI will update with new values...
      })

      $("#buy-form").on('click', function (ev) {
        ev.preventDefault();

        var Amount = $("#amount").val(), Phone = $("#phone").val(), BillRefNumber = 'datas-' + Amount
        if (Phone.length !== 12) {
          swal.fire('', "Invalid Phone Number, Please enter your phone number using format 2547xx", 'error')
          return
        }

        if (!Amount || Amount == null) {
          swal.fire('', "Please tap one Data Choice to pay", 'error')
          return
        }

        const mpesaData = {
          "route": "request-money-api",
          "shortcode": shortcode,
          "phone": Phone,
          "amount": Amount,
          "account": BillRefNumber,
          "Remarks": "remarks"
        }

        swal.fire('', 'Authenticating with M-PESA...', '')
        function handleErrors(response) {
          if (!response.ok) {
            throw Error(response.statusText);
          }
          return response;
        }

        fetch(`${lnmolink}`,
          {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(mpesaData)
          })
          .then(res => res.json())
          .then(res => {
            if (res.code == 0) {
              swal.fire('', res.msg, '')
              var x = localStorage.getItem('phone')
              if (!x) {
                localStorage.setItem('phone', Phone)
              }
            }
            else {
              swal.fire('', res.msg, '')
            }
            console.log('data sent to server and came back as follows')
            console.log(res)
          })
          .catch(err => alert('An error occured. Please pay using the manual way.'))

        console.log(mpesaData)
      })
    })


    let xhr = new XMLHttpRequest();
    xhr.open('GET', `${server}`)
    xhr.responseType = 'json';
    xhr.send()
    xhr.onload = function () {
      let responseObj = xhr.response;
      console.log(responseObj.message[0].msg);
      if (responseObj.message[0].msg !== null) {
        document.getElementById('notification').innerHTML = '<p class="text-green-700"><span class="font-bold">' + responseObj.message[0].title + '<br /> </span><span> ' + responseObj.message[0].msg + '</span></p>'
      }
    };

    function dvalue(value) {
      const amount = value
      window.document.getElementById('amount').value = value
    }

  </script>

</body>

</html>